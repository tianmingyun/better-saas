---
title: CI/CD æµæ°´çº¿
description: ä½¿ç”¨ GitHub Actions ä¸º Better SaaS è®¾ç½®è‡ªåŠ¨åŒ–æŒç»­é›†æˆå’Œéƒ¨ç½²æµæ°´çº¿ï¼ŒåŒ…å«æµ‹è¯•å’Œéƒ¨ç½²è‡ªåŠ¨åŒ–
---

# CI/CD æµæ°´çº¿

æœ¬æŒ‡å—æ¶µç›–ä½¿ç”¨ GitHub Actions ä¸º Better SaaS è®¾ç½®å®Œæ•´çš„ CI/CD æµæ°´çº¿ï¼ŒåŒ…æ‹¬è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ„å»ºå’Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚

## æ¦‚è¿°

æˆ‘ä»¬çš„ CI/CD æµæ°´çº¿åŒ…æ‹¬ï¼š
- **æŒç»­é›†æˆ**: è‡ªåŠ¨åŒ–æµ‹è¯•ã€ä»£ç æ£€æŸ¥å’Œæ„å»º
- **æŒç»­éƒ¨ç½²**: è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒ
- **è´¨é‡é—¨æ§**: ä»£ç è´¨é‡æ£€æŸ¥å’Œå®‰å…¨æ‰«æ
- **å›æ»šèƒ½åŠ›**: å‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå›æ»š

## GitHub Actions å·¥ä½œæµ

### 1. åŸºæœ¬å·¥ä½œæµç»“æ„

åˆ›å»º `.github/workflows/ci-cd.yml`ï¼š

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  test:
    name: æµ‹è¯•å’Œè´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bettersaas_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: è·å– pnpm å­˜å‚¨ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: pnpm lint

      - name: è¿è¡Œç±»å‹æ£€æŸ¥
        run: pnpm type-check

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: pnpm test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bettersaas_test
          REDIS_URL: redis://localhost:6379

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: pnpm test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bettersaas_test
          REDIS_URL: redis://localhost:6379

      - name: æ„å»ºåº”ç”¨
        run: pnpm build

      - name: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
        run: pnpm test:e2e
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bettersaas_test
          REDIS_URL: redis://localhost:6379

  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: å®¡è®¡ä¾èµ–
        run: pnpm audit

  build:
    name: æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/better-saas
            docker-compose pull
            docker-compose up -d
            docker system prune -f

  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/better-saas
            docker-compose pull
            docker-compose up -d
            docker system prune -f

      - name: å¥åº·æ£€æŸ¥
        run: |
          sleep 30
          curl -f https://yourdomain.com/health || exit 1

      - name: é€šçŸ¥éƒ¨ç½²
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### 2. ç¯å¢ƒç‰¹å®šå·¥ä½œæµ

#### é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
åˆ›å»º `.github/workflows/staging.yml`ï¼š

```yaml
name: é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²

on:
  push:
    branches: [ develop ]

jobs:
  deploy-staging:
    name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: pnpm build

      - name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒæœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/better-saas-staging
            git pull origin develop
            pnpm install --frozen-lockfile
            pnpm build
            pnpm db:migrate
            sudo systemctl restart better-saas-staging

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          sleep 30
          curl -f https://staging.yourdomain.com/health || exit 1
```

#### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
åˆ›å»º `.github/workflows/production.yml`ï¼š

```yaml
name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

on:
  release:
    types: [published]

jobs:
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: pnpm build

      - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/better-saas
            tar -czf backup-$(date +%Y%m%d_%H%M%S).tar.gz \
              --exclude=node_modules \
              --exclude=.next \
              --exclude=logs \
              .

      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/better-saas
            git pull origin main
            pnpm install --frozen-lockfile
            pnpm build
            pnpm db:migrate
            sudo systemctl restart better-saas

      - name: å¥åº·æ£€æŸ¥
        run: |
          sleep 30
          curl -f https://yourdomain.com/health || exit 1

      - name: é€šçŸ¥éƒ¨ç½²æˆåŠŸ
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: 'ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼ğŸš€'
```

## è´¨é‡é—¨æ§

### 1. ä»£ç è´¨é‡æ£€æŸ¥

åˆ›å»º `.github/workflows/quality.yml`ï¼š

```yaml
name: ä»£ç è´¨é‡

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œ ESLint
        run: pnpm lint

      - name: è¿è¡Œ Prettier
        run: pnpm format:check

      - name: è¿è¡Œ TypeScript æ£€æŸ¥
        run: pnpm type-check

      - name: è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
        run: pnpm test:coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: SonarCloud æ‰«æ
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### 2. å®‰å…¨æ‰«æ

åˆ›å»º `.github/workflows/security.yml`ï¼š

```yaml
name: å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹

jobs:
  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ä¾èµ–å®¡è®¡
        run: |
          npm audit --audit-level moderate
          pnpm audit

      - name: CodeQL åˆ†æ
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript

      - name: æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v2
```

## æ•°æ®åº“è¿ç§»

### 1. è¿ç§»å·¥ä½œæµ

åˆ›å»º `.github/workflows/migrations.yml`ï¼š

```yaml
name: æ•°æ®åº“è¿ç§»

on:
  push:
    branches: [ main ]
    paths:
      - 'drizzle/**'
      - 'src/server/db/schema.ts'

jobs:
  migrate:
    name: è¿è¡Œæ•°æ®åº“è¿ç§»
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œè¿ç§»
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/better-saas
            pnpm db:migrate
            pnpm db:seed
```

### 2. å›æ»šèƒ½åŠ›

åœ¨ `scripts/rollback.sh` ä¸­åˆ›å»ºå›æ»šè„šæœ¬ï¼š

```bash
#!/bin/bash

# Better SaaS éƒ¨ç½²å›æ»šè„šæœ¬
set -e

BACKUP_DIR="/opt/backups"
ROLLBACK_TAG=${1:-"previous"}

echo "å¼€å§‹å›æ»šåˆ° $ROLLBACK_TAG..."

# åœæ­¢åº”ç”¨
sudo systemctl stop better-saas

# ä»å¤‡ä»½æ¢å¤
if [ -f "$BACKUP_DIR/backup-$ROLLBACK_TAG.tar.gz" ]; then
    cd /opt/better-saas
    tar -xzf "$BACKUP_DIR/backup-$ROLLBACK_TAG.tar.gz"
    echo "ä»å¤‡ä»½æ¢å¤åº”ç”¨æ–‡ä»¶"
else
    echo "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ï¼Œé€šè¿‡ git å›æ»š..."
    cd /opt/better-saas
    git checkout $ROLLBACK_TAG
    pnpm install --frozen-lockfile
    pnpm build
fi

# å¦‚éœ€è¦ï¼Œæ¢å¤æ•°æ®åº“
if [ -f "$BACKUP_DIR/db-backup-$ROLLBACK_TAG.sql.gz" ]; then
    echo "æ¢å¤æ•°æ®åº“å¤‡ä»½..."
    gunzip -c "$BACKUP_DIR/db-backup-$ROLLBACK_TAG.sql.gz" | psql -U bettersaas -d bettersaas_prod
fi

# å¯åŠ¨åº”ç”¨
sudo systemctl start better-saas

# å¥åº·æ£€æŸ¥
sleep 30
if curl -f http://localhost:3000/health > /dev/null 2>&1; then
    echo "å›æ»šæˆåŠŸï¼åº”ç”¨è¿è¡Œæ­£å¸¸ã€‚"
else
    echo "å›æ»šå¤±è´¥ï¼åº”ç”¨æ— å“åº”ã€‚"
    exit 1
fi
```

## ç›‘æ§å’Œé€šçŸ¥

### 1. Slack é€šçŸ¥

åˆ›å»º `.github/workflows/notifications.yml`ï¼š

```yaml
name: é€šçŸ¥

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

jobs:
  notify:
    name: å‘é€é€šçŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æˆåŠŸé€šçŸ¥
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            âœ… éƒ¨ç½²æˆåŠŸï¼
            ä»“åº“: ${{ github.repository }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}

      - name: å¤±è´¥é€šçŸ¥
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            âŒ éƒ¨ç½²å¤±è´¥ï¼
            ä»“åº“: ${{ github.repository }}
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚
```

### 2. é‚®ä»¶é€šçŸ¥

åœ¨å·¥ä½œæµä¸­é…ç½®é‚®ä»¶é€šçŸ¥ï¼š

```yaml
- name: å‘é€é‚®ä»¶é€šçŸ¥
  if: failure()
  uses: dawidd6/action-send-mail@v3
  with:
    server_address: smtp.gmail.com
    server_port: 465
    username: ${{ secrets.EMAIL_USERNAME }}
    password: ${{ secrets.EMAIL_PASSWORD }}
    subject: 'éƒ¨ç½²å¤±è´¥ - Better SaaS'
    body: |
      éƒ¨ç½²æµæ°´çº¿å¤±è´¥ã€‚
      
      ä»“åº“: ${{ github.repository }}
      åˆ†æ”¯: ${{ github.ref }}
      æäº¤: ${{ github.sha }}
      
      è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–æ›´å¤šè¯¦æƒ…ã€‚
    to: admin@yourdomain.com
    from: noreply@yourdomain.com
```

## ç¯å¢ƒé…ç½®

### 1. GitHub å¯†é’¥

åœ¨ GitHub ä»“åº“ä¸­é…ç½®ä»¥ä¸‹å¯†é’¥ï¼š

#### ç”Ÿäº§ç¯å¢ƒ
- `PRODUCTION_HOST`: ç”Ÿäº§æœåŠ¡å™¨ IP/ä¸»æœºå
- `PRODUCTION_USER`: ç”Ÿäº§ç¯å¢ƒ SSH ç”¨æˆ·å
- `PRODUCTION_SSH_KEY`: ç”Ÿäº§ç¯å¢ƒ SSH ç§é’¥
- `DATABASE_URL`: ç”Ÿäº§æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
- `BETTER_AUTH_SECRET`: ç”Ÿäº§è®¤è¯å¯†é’¥
- `STRIPE_SECRET_KEY`: ç”Ÿäº§ Stripe å¯†é’¥
- `CLOUDFLARE_R2_ACCESS_KEY_ID`: ç”Ÿäº§ R2 è®¿é—®å¯†é’¥
- `CLOUDFLARE_R2_SECRET_ACCESS_KEY`: ç”Ÿäº§ R2 å¯†é’¥

#### é¢„å‘å¸ƒç¯å¢ƒ
- `STAGING_HOST`: é¢„å‘å¸ƒæœåŠ¡å™¨ IP/ä¸»æœºå
- `STAGING_USER`: é¢„å‘å¸ƒç¯å¢ƒ SSH ç”¨æˆ·å
- `STAGING_SSH_KEY`: é¢„å‘å¸ƒç¯å¢ƒ SSH ç§é’¥

#### é€šçŸ¥
- `SLACK_WEBHOOK`: Slack webhook URL
- `EMAIL_USERNAME`: é‚®ä»¶é€šçŸ¥ SMTP ç”¨æˆ·å
- `EMAIL_PASSWORD`: é‚®ä»¶é€šçŸ¥ SMTP å¯†ç 

#### å¤–éƒ¨æœåŠ¡
- `CODECOV_TOKEN`: Codecov è¦†ç›–ç‡æŠ¥å‘Šä»¤ç‰Œ
- `SONAR_TOKEN`: SonarCloud ä»£ç è´¨é‡ä»¤ç‰Œ
- `GITHUB_TOKEN`: GitHub ä»¤ç‰Œï¼ˆè‡ªåŠ¨æä¾›ï¼‰

### 2. ç¯å¢ƒæ–‡ä»¶

åˆ›å»ºç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼š

#### `.env.staging`
```
NODE_ENV=staging
DATABASE_URL=postgresql://staging_user:password@staging-db:5432/bettersaas_staging
BETTER_AUTH_URL=https://staging.yourdomain.com
STRIPE_SECRET_KEY=sk_test_staging_key
```

#### `.env.production`
```
NODE_ENV=production
DATABASE_URL=postgresql://prod_user:password@prod-db:5432/bettersaas_prod
BETTER_AUTH_URL=https://yourdomain.com
STRIPE_SECRET_KEY=sk_live_production_key
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ„å»ºä¼˜åŒ–

ä¼˜åŒ–æ„å»ºè¿‡ç¨‹ï¼š

```yaml
- name: ä¼˜åŒ–æ„å»º
  run: |
    export NODE_ENV=production
    export NEXT_TELEMETRY_DISABLED=1
    pnpm build
  env:
    NEXT_TELEMETRY_DISABLED: 1
```

### 2. ç¼“å­˜ä¼˜åŒ–

å®ç°æ™ºèƒ½ç¼“å­˜ï¼š

```yaml
- name: ç¼“å­˜ node modules
  uses: actions/cache@v3
  with:
    path: ~/.pnpm-store
    key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-pnpm-

- name: ç¼“å­˜ Next.js æ„å»º
  uses: actions/cache@v3
  with:
    path: |
      ~/.npm
      ${{ github.workspace }}/.next/cache
    key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
    restore-keys: |
      ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ„å»ºå¤±è´¥**
   ```bash
   # æ£€æŸ¥æ—¥å¿—
   cat /var/log/better-saas/build.log
   
   # éªŒè¯ä¾èµ–
   pnpm install --frozen-lockfile
   
   # æ¸…ç†ç¼“å­˜
   pnpm store prune
   ```

2. **éƒ¨ç½²å¤±è´¥**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   sudo systemctl status better-saas
   
   # æ£€æŸ¥éƒ¨ç½²æ—¥å¿—
   sudo journalctl -u better-saas -f
   
   # éªŒè¯æ–‡ä»¶æƒé™
   ls -la /opt/better-saas
   ```

3. **æ•°æ®åº“è¿ç§»é—®é¢˜**
   ```bash
   # æ£€æŸ¥è¿ç§»çŠ¶æ€
   pnpm db:status
   
   # å›æ»šè¿ç§»
   pnpm db:rollback
   
   # é‡ç½®æ•°æ®åº“
   pnpm db:reset
   ```

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
gh workflow list
gh workflow view ci-cd.yml

# æ£€æŸ¥éƒ¨ç½²æ—¥å¿—
ssh user@server 'sudo journalctl -u better-saas -f'

# æœ¬åœ°æµ‹è¯•éƒ¨ç½²
docker-compose up -d
curl -f http://localhost:3000/health
```

## æœ€ä½³å®è·µ

1. **åˆ†æ”¯ä¿æŠ¤**: ä¸ºä¸»åˆ†æ”¯å¯ç”¨åˆ†æ”¯ä¿æŠ¤è§„åˆ™
2. **å¿…éœ€å®¡æŸ¥**: åˆå¹¶å‰è¦æ±‚ä»£ç å®¡æŸ¥
3. **çŠ¶æ€æ£€æŸ¥**: ä½¿ CI/CD æ£€æŸ¥æˆä¸ºåˆå¹¶çš„å¿…éœ€æ¡ä»¶
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**: ä¿æŒé«˜æµ‹è¯•è¦†ç›–ç‡
5. **å®‰å…¨æ‰«æ**: å®šæœŸè¿›è¡Œå®‰å…¨æ‰«æå’Œä¾èµ–æ›´æ–°
6. **ç›‘æ§**: ç›‘æ§éƒ¨ç½²æˆåŠŸå’Œåº”ç”¨å¥åº·çŠ¶æ€
7. **å›æ»šç­–ç•¥**: å§‹ç»ˆå‡†å¤‡å¥½å›æ»šè®¡åˆ’
8. **æ–‡æ¡£**: ä¿æŒéƒ¨ç½²æ–‡æ¡£çš„æ›´æ–°

## ä¸‹ä¸€æ­¥

- è®¾ç½® [ç›‘æ§å’Œå‘Šè­¦](../development/monitoring)
- é…ç½® [é”™è¯¯è·Ÿè¸ª](../development/error-tracking)
- å®æ–½ [æ€§èƒ½ç›‘æ§](../development/performance)
- æŸ¥çœ‹ [å®‰å…¨æœ€ä½³å®è·µ](../development/security) 